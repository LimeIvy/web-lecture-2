# ポストの一覧表示

バックエンドAPIから投稿データを取得し、フロントエンドで一覧表示する機能の実装方法を説明します。

## フロントエンドとバックエンドの接続

### 1. APIエンドポイントの確認

バックエンドの `src/routes/posts.ts` で、投稿一覧を取得するエンドポイントが定義されています：

```typescript:backend/src/routes/posts.ts
const posts = new Hono()
  .get("/", (c) => {
    const posts = db.prepare("SELECT * FROM posts ORDER BY created_at DESC").all();
    return c.json(posts);
  })
```

このエンドポイントは `GET http://localhost:8080/posts` でアクセスできます。

### 2. 型定義の確認

フロントエンドでは、`src/types/post.ts` で投稿の型が定義されています：

```typescript:frontend/src/types/post.ts
export type PostType = {
  id: string;
  content: string;
  created_at: string;
  user: {
    id: string;
    name: string;
    icon: string | null;
  };
};
```

バックエンドのレスポンス形式とフロントエンドの型定義が一致している必要があります。

### 3. API呼び出しの実装

フロントエンドからバックエンドAPIを呼び出すには、`fetch` APIを使用します。

#### 基本的な実装例

```typescript
const fetchPosts = async () => {
  try {
    const response = await fetch("http://localhost:8080/posts");
    if (!response.ok) {
      throw new Error("Failed to fetch posts");
    }
    const data = await response.json();
    return data;
  } catch (error) {
    console.error("Error fetching posts:", error);
    throw error;
  }
};
```

#### Reactコンポーネントでの使用

`useState` と `useEffect` を使用して、コンポーネントマウント時にデータを取得：

```typescript
import { useState, useEffect } from "react";
import type { PostType } from "../types/post";

const PostList = () => {
  const [posts, setPosts] = useState<PostType[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchPosts = async () => {
      try {
        setLoading(true);
        const response = await fetch("http://localhost:8080/posts");
        if (!response.ok) {
          throw new Error("Failed to fetch posts");
        }
        const data = await response.json();
        setPosts(data);
      } catch (err) {
        setError(err instanceof Error ? err.message : "Unknown error");
      } finally {
        setLoading(false);
      }
    };

    fetchPosts();
  }, []);

  if (loading) return <div>読み込み中...</div>;
  if (error) return <div>エラー: {error}</div>;

  return (
    <div>
      {posts.map((post) => (
        <div key={post.id}>{post.content}</div>
      ))}
    </div>
  );
};
```

## ポストの一覧表示

### 1. データの変換

バックエンドから返されるデータ形式がフロントエンドの型定義と異なる場合、変換処理が必要です。

#### バックエンドのレスポンス形式

現在の実装では、バックエンドは以下の形式でデータを返します：

```json
[
  {
    "id": "1",
    "content": "投稿内容",
    "created_at": "2024-01-01T00:00:00.000Z",
    "user_id": "user1"
  }
]
```

#### フロントエンドで必要な形式

フロントエンドの `PostType` では、以下の形式が必要です：

```typescript
{
  id: string;
  content: string;
  created_at: string;
  user: {
    id: string;
    name: string;
    icon: string | null;
  };
}
```

#### 解決方法: バックエンドで変換

バックエンドの `posts.ts` で、JOINクエリを使用してユーザー情報を含めて返す：

```typescript
const posts = db.prepare(`
  SELECT 
    posts.id,
    posts.content,
    posts.created_at,
    posts.user_id,
    users.name,
    users.icon
  FROM posts 
  LEFT JOIN users ON posts.user_id = users.id 
  ORDER BY posts.created_at DESC
`).all();

return c.json(posts.map((post: any) => ({
  id: post.id,
  content: post.content,
  created_at: post.created_at,
  user: {
    id: post.user_id,
    name: post.name || "",
    icon: post.icon || null,
  }
})));
```

### 2. エラーハンドリング

API呼び出し時には、以下のエラーケースを考慮する必要があります：

- **ネットワークエラー**: サーバーに接続できない
- **HTTPエラー**: 4xx, 5xxステータスコード
- **データ形式エラー**: レスポンスが期待する形式でない

```typescript
try {
  const response = await fetch("http://localhost:8080/posts");
  
  if (!response.ok) {
    if (response.status === 404) {
      throw new Error("投稿が見つかりません");
    } else if (response.status >= 500) {
      throw new Error("サーバーエラーが発生しました");
    } else {
      throw new Error(`エラーが発生しました: ${response.status}`);
    }
  }
  
  const data = await response.json();
  // データの検証
  if (!Array.isArray(data)) {
    throw new Error("無効なデータ形式です");
  }
  
  return data;
} catch (error) {
  if (error instanceof TypeError && error.message.includes("fetch")) {
    throw new Error("サーバーに接続できません");
  }
  throw error;
}
```

### 3. ローディング状態の表示

データ取得中は、ローディングインジケーターを表示します：

```typescript
const [loading, setLoading] = useState(true);

// ローディング中の表示
if (loading) {
  return (
    <div className="flex items-center justify-center p-8">
      <div className="text-gray-500">読み込み中...</div>
    </div>
  );
}
```

### 4. 既存コンポーネントとの統合

`App.tsx` で、モックデータの代わりにAPIから取得したデータを使用：

```typescript
// 変更前
import { mockPosts } from "./mocks/posts";
<Post posts={mockPosts} />

// 変更後
const [posts, setPosts] = useState<PostType[]>([]);

useEffect(() => {
  fetchPosts().then(setPosts);
}, []);

<Post posts={posts} />
```

## CORS設定

フロントエンド（`http://localhost:5173`）からバックエンド（`http://localhost:8080`）にアクセスする際、CORS（Cross-Origin Resource Sharing）の設定が必要です。

バックエンドの `src/index.ts` で既に設定されています：

```typescript:backend/src/index.ts
app.use(
  "*",
  cors({
    origin: "*",
  })
);
```

これにより、すべてのオリジンからのリクエストが許可されます。

## 修正後のコード一覧

このセクションでは、マークダウンファイルを通じて変更されたすべてのコードを記載します。

### 1. バックエンドAPI (`backend/src/routes/posts.ts`)

JOINクエリを使用してユーザー情報を含め、フロントエンド用の形式に変換して返す：

```typescript
import { Hono } from "hono";
import db from "../db/initial";

const posts = new Hono()
  // テスト用: 投稿一覧取得(ユーザ情報付き)
  .get("/", (c) => {
    const posts = db.prepare(`
      SELECT 
        posts.id,
        posts.content,
        posts.created_at,
        posts.user_id,
        users.name,
        users.icon
      FROM posts 
      LEFT JOIN users ON posts.user_id = users.id 
      ORDER BY posts.created_at DESC
    `).all();

    return c.json(posts.map((post: any) => ({
      id: post.id,
      content: post.content,
      created_at: post.created_at,
      user: {
        id: post.user_id,
        name: post.name || "",
        icon: post.icon || null,
      }
    })));
  })

export default posts;
```

### 2. Appコンポーネント (`frontend/src/App.tsx`)

APIからデータを取得して表示する実装：

```typescript
import { useState, useEffect } from "react";
import { LeftSidebar } from "./components/sidebar/LeftSidebar";
import { RightSidebar } from "./components/sidebar/RightSidebar";
import { Header } from "./components/Header";
import { PostForm } from "./components/PostForm";
import Post from "./components/Post";
import type { PostType } from "./types/post";

function App() {
  const [posts, setPosts] = useState<PostType[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchPosts = async () => {
      try {
        setLoading(true);
        const response = await fetch("http://localhost:8080/posts");
        if (!response.ok) {
          throw new Error("Failed to fetch posts");
        }
        const data = await response.json();
        setPosts(data);
      } catch (err) {
        setError(err instanceof Error ? err.message : "Unknown error");
      } finally {
        setLoading(false);
      }
    };

    fetchPosts();
  }, []);

  return (
    <div className="flex min-h-screen justify-center bg-black">
      {/* コンテンツラッパー */}
      <div className="flex w-full max-w-7xl">
        {/* レフトサイドバー */}
        <div className="w-[68px] flex-shrink-0 lg:w-[275px]">
          <LeftSidebar />
        </div>

        {/* メインコンテンツ */}
        <div className="min-h-screen w-full max-w-[600px] border-x border-gray-800">
          <Header title="おすすめ" />
          {/* 投稿フォーム */}
          <PostForm />
          {/* 投稿一覧 */}
          {loading ? (
            <div className="flex items-center justify-center p-8">
              <div className="text-gray-500">読み込み中...</div>
            </div>
          ) : error ? (
            <div className="flex items-center justify-center p-8">
              <div className="text-red-500">エラー: {error}</div>
            </div>
          ) : (
            <Post posts={posts} />
          )}
        </div>

        {/* ライトサイドバー - 大画面のみ表示 */}
        <div className="hidden w-[350px] flex-shrink-0 lg:block">
          <RightSidebar />
        </div>
      </div>
    </div>
  );
}

export default App;
```
